<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>Multicampus 코스 러너 — v29 (Hotfix + Error Catcher)</title>
<style>
  :root{
    --bg:#f7f7f8; --ink:#111; --muted:#666; --accent:#ff7a00; --panel:#fff;
    --safe-top: env(safe-area-inset-top, 0px); --safe-bottom: env(safe-area-inset-bottom, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Arial,Apple Color Emoji,Noto Color Emoji,sans-serif;
    -webkit-text-size-adjust:100%;}
  body.immersive{background:#eef3ff}
  .wrap{min-height:100svh;min-height:100dvh;display:flex;flex-direction:column;padding-bottom:var(--safe-bottom)}

  header{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:.5rem;
    padding:calc(.5rem + var(--safe-top)/2) .8rem .5rem;background:rgba(255,255,255,.94);backdrop-filter:saturate(140%) blur(6px);
    border-bottom:1px solid #e9e9ee}
  body.immersive header{display:none}
  .logo{font-weight:800;letter-spacing:.2px;font-size:1.1rem;line-height:1;position:relative;color:var(--ink);cursor:pointer;user-select:none}
  .logo .i{position:relative;display:inline-block}
  .logo .i .dot{position:absolute;left:50%;transform:translateX(-50%);width:.45em;height:.45em;border-radius:50%;background:var(--accent);top:-.18em}
  .hud{display:flex;align-items:center;gap:.35rem .45rem;flex-wrap:wrap;font-weight:700}
  .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.28rem .5rem;border-radius:999px;background:var(--panel);border:1px solid #eee;font-variant-numeric:tabular-nums}
  .pill small{font-weight:600;color:var(--muted)}
  .btn{appearance:none;border:1px solid #ddd;background:var(--panel);padding:.42rem .6rem;border-radius:.6rem;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:var(--accent);outline:2px solid rgba(255,122,0,.12)}

  .canvas-box{position:relative;flex:1;display:flex;align-items:center;justify-content:center;padding:10px}
  @media (pointer:coarse){ .canvas-box{padding:0} }
  canvas{background:linear-gradient(#eaf3ff 0%, #fefefe 40%);width:100%;max-width:980px;height:auto;aspect-ratio:16/9;
    border-radius:12px;border:1px solid #e3e7ef;touch-action:none}
  @media (pointer:coarse){ canvas{border:none;border-radius:0;max-width:100vw} }
  @supports not (aspect-ratio: 16/9){ canvas{height:auto}}

  /* Overlays */
  .overlay{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:14px}
  .panel{pointer-events:auto;background:rgba(255,255,255,.96);border:1px solid #e5e7ee;border-radius:14px;padding:16px;max-width:min(92vw,720px);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.06)}
  h1{margin:.2rem 0 .6rem;font-size:clamp(1.05rem, 2.8vw, 1.35rem)}
  .tips{color:var(--muted);font-size:.95rem;line-height:1.45}
  .btn-row{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap}
  .char-grid{display:grid;grid-template-columns:repeat(7, minmax(38px,1fr));gap:8px;justify-items:center}
  .char-btn{width:46px;height:46px;border-radius:10px;border:1px solid #e3e3ea;background:#fff;cursor:pointer;font-size:26px;display:grid;place-items:center}
  .char-btn[aria-pressed="true"]{outline:3px solid rgba(255,122,0,.25);border-color:var(--accent);transform:translateY(-1px)}
  .diff-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
  .diff-btn{padding:.45rem .8rem;border-radius:.7rem;border:1px solid #e3e3ea;background:#fff;cursor:pointer;font-weight:800}
  .diff-btn[data-diff="easy"]::after{content:"  하"} .diff-btn[data-diff="normal"]::after{content:"  중"} .diff-btn[data-diff="hard"]::after{content:"  상"}
  .diff-btn[aria-pressed="true"]{outline:3px solid rgba(255,122,0,.25);border-color:var(--accent);transform:translateY(-1px)}

  .toast{position:absolute;left:50%;top:10%;transform:translateX(-50%);background:var(--panel);border:1px solid #e5e7ee;border-radius:10px;padding:.4rem .6rem;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,.06);opacity:0;transition:opacity .25s, transform .25s;white-space:nowrap}
  .toast.show{opacity:1;transform:translate(-50%,0)}
  .combo-pop{position:absolute;left:50%;bottom:14%;transform:translateX(-50%);font-weight:900;font-size:1.2rem;color:var(--accent);opacity:0;transition:opacity .3s, transform .3s;text-shadow:0 2px 0 rgba(0,0,0,.05)}

  .floating-controls{position:fixed;z-index:6;left:8px;top:calc(8px + var(--safe-top));display:none;gap:6px;align-items:center}
  body.immersive .floating-controls{display:flex}
  .float-btn{appearance:none;border:1px solid #e3e3ea;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-radius:999px;padding:.35rem .6rem;font-weight:800}

  .touch-layer{position:absolute;inset:0;pointer-events:auto;touch-action:none}

  /* Error catcher */
  .error-overlay{position:fixed;z-index:9999;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);}
  .error-overlay .box{max-width:min(92vw,720px);background:#fff;border-radius:12px;border:1px solid #e3e3ea;padding:14px}
  .error-overlay h2{margin:0 0 8px 0;font-size:1.1rem}
  .error-overlay pre{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#f7f7f8;border:1px solid #eee;padding:8px;border-radius:8px;max-height:40vh;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <header id="appHeader">
    <div id="homeLogo" class="logo" role="button" title="초기 화면">
      <span class="word">mult<span class="i">ı<span class="dot"></span></span>campus</span>
    </div>
    <div class="hud" aria-live="polite">
      <div class="pill"><small>점수</small><span id="score">0</span></div>
      <div class="pill"><small>콤보</small><span id="combo">x1</span></div>
      <div class="pill"><small>라이프</small><span id="livesText">❤️❤️❤️</span><span id="livesNum">(3)</span></div>
      <div class="pill" id="shieldPill" style="display:none"><small>무적</small><span id="shieldTime">0.0s</span></div>
      <div class="pill"><small>난이도</small><span id="diffLabel">중</span></div>
      <div class="pill"><small>최고</small><span id="best">0</span></div>
      <button id="muteBtn" class="btn" aria-pressed="true" aria-label="사운드 토글">🔇</button>
      <button id="pauseBtn" class="btn">⏸️</button>
      <button id="immersiveBtn" class="btn">📱 전면</button>
    </div>
  </header>

  <div class="floating-controls">
    <button id="exitImmersiveBtn" class="float-btn">↩︎ 종료</button>
    <button id="pauseFloatBtn" class="float-btn">⏸️</button>
  </div>

  <div class="canvas-box">
    <canvas id="game" width="960" height="540" aria-label="코스 러너 게임 캔버스"></canvas>
    <div id="touchLayer" class="touch-layer" aria-hidden="true"></div>

    <!-- Start -->
    <div id="startOverlay" class="overlay">
      <div class="panel">
        <h1>코스 러너 — 캐릭터·난이도 선택</h1>
        <div class="tips">모바일은 <b>📱 전면</b>을 누르면 화면이 더 크게 보입니다. 화면 아무 곳이나 탭해서 점프!</div>
        <div class="char-grid" role="group" aria-label="캐릭터 선택"></div>
        <div class="diff-row" role="group" aria-label="난이도 선택">
          <button class="diff-btn" data-diff="easy" aria-pressed="false">난이도</button>
          <button class="diff-btn" data-diff="normal" aria-pressed="true">난이도</button>
          <button class="diff-btn" data-diff="hard" aria-pressed="false">난이도</button>
        </div>
        <div class="btn-row" style="margin-top:10px">
          <button class="btn primary" id="startBtn">▶️ 시작하기</button>
          <button class="btn" id="enterImmersiveBtn">📱 전면 시작</button>
        </div>
      </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverOverlay" class="overlay" style="display:none">
      <div class="panel">
        <h1>게임 종료</h1>
        <p class="tips" id="finalText">점수 0</p>
        <div class="btn-row" style="margin-top:10px">
          <button class="btn primary" id="retryBtn">↻ 다시 시작</button>
          <button class="btn" id="changeCharBtn">🐾 캐릭터 변경</button>
          <button class="btn" id="changeDiffBtn">🎚️ 난이도 변경</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Error catcher overlay -->
<div id="errOL" class="error-overlay" role="dialog" aria-modal="true">
  <div class="box">
    <h2>⚠️ 실행 오류를 감지했어요</h2>
    <pre id="errMsg">알 수 없는 오류</pre>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="errClose" class="btn">닫기</button>
    </div>
  </div>
</div>

<script>
(()=>{
  'use strict';
  const $=s=>document.querySelector(s);
  const canvas=$('#game'), ctx=canvas.getContext('2d',{alpha:true});
  const header=$('#appHeader');
  const touchLayer=$('#touchLayer');
  const errOL=$('#errOL'), errMsg=$('#errMsg'), errClose=$('#errClose');

  // ===== Error catcher =====
  function showError(e){ try{ errMsg.textContent = (e && e.message) ? (e.message + (e.filename?`\\n${e.filename}:${e.lineno}:${e.colno}`:'')) : String(e); }catch(_){ errMsg.textContent=String(e); } errOL.style.display='flex'; }
  window.addEventListener('error', (e)=>{ showError(e.error||e.message||e); });
  window.addEventListener('unhandledrejection', (e)=>{ showError(e.reason||e); });
  errClose.addEventListener('click', ()=>{ errOL.style.display='none'; });

  // ===== Mobile detection & sprite scale =====
  const isCoarse=()=> (window.matchMedia && window.matchMedia('(pointer:coarse)').matches) || (Math.min(screen.width, screen.height) <= 820);
  let MOBILE_SCALE = isCoarse()? 0.82 : 1.0;
  let immersive=false;

  // ===== Responsive sizing =====
  let headerH=0;
  new ResizeObserver(()=>{ headerH = Math.ceil(header.getBoundingClientRect().height); fitCanvas(); }).observe(header);
  function fitCanvas(){
    const dpr = Math.min(window.devicePixelRatio||1, 3);
    const aspect = 16/9;
    const vv = (window.visualViewport && window.visualViewport.height) ? window.visualViewport.height : window.innerHeight;
    const safeBottom = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom, 0px)')) || 0;
    const hiddenHeader = document.body.classList.contains('immersive');
    const topSpace = hiddenHeader ? 0 : headerH;
    const avail = Math.max(220, vv - topSpace - 6 - safeBottom);
    const width = document.documentElement.clientWidth || window.innerWidth;
    let cssW = Math.min(width, 980);
    let cssH = Math.round(cssW/aspect);
    if(cssH > avail){ cssH = Math.max(180, Math.floor(avail)); cssW = Math.round(cssH*aspect); }
    canvas.style.width = cssW+'px'; canvas.style.height = cssH+'px';
    canvas.width = Math.round(cssW*dpr); canvas.height = Math.round(cssH*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  fitCanvas();
  const vfHandler=()=>fitCanvas();
  if(window.visualViewport){
    visualViewport.addEventListener('resize', vfHandler);
    visualViewport.addEventListener('scroll', vfHandler);
  }
  window.addEventListener('resize', vfHandler);
  window.addEventListener('orientationchange', ()=> setTimeout(vfHandler, 120));

  // ===== Touch layer: tap anywhere to jump =====
  let lastJumpAt=0;
  function handleJump(e){ e.preventDefault(); const now=performance.now(); if(now-lastJumpAt<100) return; lastJumpAt=now; doJump(); }
  ['pointerdown','touchstart','mousedown'].forEach(ev=>{
    touchLayer.addEventListener(ev, handleJump, {passive:false});
    canvas.addEventListener(ev, handleJump, {passive:false});
  });

  // ===== Fullscreen / Immersive =====
  async function enterImmersive(){
    immersive = true;
    document.body.classList.add('immersive');
    if(isCoarse()){ MOBILE_SCALE = 0.9; resizePlayerOnly(); } // 더 크게
    fitCanvas();
    const el = document.documentElement;
    try{
      if(el.requestFullscreen){ await el.requestFullscreen({navigationUI:'hide'}); }
      else if(el.webkitRequestFullscreen){ el.webkitRequestFullscreen(); }
    }catch(e){ /* ignore */ }
  }
  async function exitImmersive(){
    immersive=false;
    document.body.classList.remove('immersive');
    if(isCoarse()){ MOBILE_SCALE = 0.82; resizePlayerOnly(); }
    fitCanvas();
    try{
      if(document.fullscreenElement && document.exitFullscreen){ await document.exitFullscreen(); }
      else if(document.webkitFullscreenElement && document.webkitExitFullscreen){ document.webkitExitFullscreen(); }
    }catch(e){ /* ignore */ }
  }
  $('#immersiveBtn').addEventListener('click', enterImmersive);
  $('#enterImmersiveBtn').addEventListener('click', ()=>{ start(); enterImmersive(); });
  $('#exitImmersiveBtn').addEventListener('click', exitImmersive);

  // ===== Game state =====
  const GROUND_H=56;
  const player={ x:80, y:0, w:Math.round(46*MOBILE_SCALE), h:Math.round(52*MOBILE_SCALE), vy:0, onGround:false, jumpsLeft:2, blink:0, facing:1 };
  const obstacles=[], coins=[], hearts=[], stars=[];
  const courseNames=["실무자를 위한 Power Excel","ChatGPT로 업무생산성 높이기","2일만에 끝내는 파이썬 자동화","공공정보화 발주관리","데이터·AI 트렌드","SQL 쿼리 작성 비법","노코드 앱 개발","Linux 따라하며 배우기","엑셀 매크로 & VBA"];

  // UI refs
  const scoreEl=$('#score'), bestEl=$('#best'), comboEl=$('#combo');
  const livesTextEl=$('#livesText'), livesNumEl=$('#livesNum');
  const shieldPill=$('#shieldPill'), shieldTimeEl=$('#shieldTime');
  const toastEl=$('#toast'), comboPopEl=$('#comboPop'), diffLabel=$('#diffLabel');
  const startOverlay=$('#startOverlay'), gameOverOverlay=$('#gameOverOverlay');
  const startBtn=$('#startBtn'), retryBtn=$('#retryBtn'), changeCharBtn=$('#changeCharBtn'), changeDiffBtn=$('#changeDiffBtn');
  const pauseBtn=$('#pauseBtn'), muteBtn=$('#muteBtn');
  const homeLogo=$('#homeLogo');

  const CHAR_SET=['🐡','🐈','🦛','🦉','🐘','🦔','🐖'];
  let selectedChar = localStorage.getItem('mc_runner_char') || '🐡';
  let selectedDiff = localStorage.getItem('mc_runner_diff') || 'normal';
  const charGrid=document.querySelector('.char-grid');
  const diffButtons=[...document.querySelectorAll('.diff-btn')];

  function buildCharGrid(){
    charGrid.innerHTML='';
    CHAR_SET.forEach(ch=>{
      const b=document.createElement('button');
      b.className='char-btn'; b.type='button'; b.textContent=ch;
      b.setAttribute('aria-pressed', (ch===selectedChar).toString());
      b.addEventListener('click', ()=>{
        selectedChar=ch; localStorage.setItem('mc_runner_char', ch);
        [...charGrid.children].forEach(x=>x.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
      });
      charGrid.appendChild(b);
    });
  }
  function initDiffButtons(){
    diffButtons.forEach(btn=>{
      btn.setAttribute('aria-pressed', (btn.dataset.diff===selectedDiff).toString());
      btn.addEventListener('click', ()=>{
        selectedDiff = btn.dataset.diff; localStorage.setItem('mc_runner_diff', selectedDiff);
        diffButtons.forEach(x=>x.setAttribute('aria-pressed','false'));
        btn.setAttribute('aria-pressed','true');
        diffLabel.textContent = DIFF_PRESETS[selectedDiff]?.label || '중';
      });
    });
  }

  // Difficulty
  const DIFF_PRESETS = {
    easy:   { label:'하', speedSlope:0.35, speedMax:8.5, diffSlope:0.028, diffMax:0.8, burst:0.08, coinMul:1.6, heartMul:0.8, starMul:0.9, aggression:0.6 },
    normal: { label:'중', speedSlope:0.45, speedMax:10.0, diffSlope:0.035, diffMax:1.0, burst:0.12, coinMul:2.5, heartMul:4.0, starMul:5.0, aggression:1.0 },
    hard:   { label:'상', speedSlope:0.70, speedMax:12.0, diffSlope:0.055, diffMax:1.6, burst:0.22, coinMul:3.5, heartMul:6.0, starMul:7.0, aggression:1.5 },
  };
  function getPreset(){ return DIFF_PRESETS[selectedDiff] || DIFF_PRESETS.normal; }
  function diffFactor(t){ const p=getPreset(); return 1 + Math.min(p.diffMax, t*p.diffSlope); }

  // HUD
  let running=false, paused=false, over=false;
  let score=0, best=Number(localStorage.getItem('mc_runner_best')||0); bestEl && (bestEl.textContent=best);
  let combo=1, lastCoinTime=0;
  let lives=3, maxLives=5, invulHit=0, invulPower=0;
  function livesHUD(){ livesTextEl.textContent = '❤️'.repeat(lives) + '🤍'.repeat(Math.max(0, maxLives - lives)); livesNumEl.textContent = `(${lives})`; }
  function shieldHUD(){ if(invulPower>0){ shieldPill.style.display='inline-flex'; shieldTimeEl.textContent = invulPower.toFixed(1)+'s'; } else { shieldPill.style.display='none'; } }
  function updateHUD(){ scoreEl.textContent=Math.floor(score); comboEl.textContent='x'+combo; livesHUD(); shieldHUD(); }

  // Spawners (mobile scale)
  let obsTimer=0, coinTimer=0, heartTimer=0, starTimer=0;
  function spawnObstacle(){
    const H=canvas.height/window.devicePixelRatio, groundY=H-GROUND_H, s=MOBILE_SCALE;
    const df = diffFactor(time); const p = getPreset(); const ag = p.aggression;
    const h=Math.max(22*s, Math.min(112*s, (24 + Math.random()*(78 + (df-1)*10*ag))*s));
    const w=Math.max(18*s, Math.min(82*s, (22 + Math.random()*(46 + (df-1)*8*ag))*s));
    const r=Math.random();
    if(r< (0.12*ag)){
      const amp = (6 + Math.random()* (12 + 4*(ag-1))) * 0.9;
      const spd = 1.6 + Math.random()* (2.6 + 0.8*(ag-1));
      obstacles.push({x:canvas.width/window.devicePixelRatio + w, y:groundY-h, w, h, passed:false, color:'#23242a', type:'float', a:amp, s:spd, t:0});
    }else if(r< (0.28*ag)){
      const baseGap = 28 + (1.6-df)*10 + (Math.random()*16-6);
      const gap = Math.max(16*s, Math.min(44*s, baseGap*(1 - 0.18*(ag-1))*s));
      const h2 = Math.max(22*s, Math.min(110*s, h + (Math.random()*24-10)));
      obstacles.push({x:canvas.width/window.devicePixelRatio + w, y:groundY-h, w, h, passed:false, color:'#23242a', type:'normal'});
      obstacles.push({x:canvas.width/window.devicePixelRatio + w + w + gap, y:groundY-h2, w:Math.max(20*s,Math.min(86*s,w+(Math.random()*14-6))), h:h2, passed:false, color:'#23242a', type:'normal'});
    }else{
      obstacles.push({x:canvas.width/window.devicePixelRatio + w, y:groundY-h, w, h, passed:false, color:'#23242a', type:'normal'});
    }
  }
  function spawnCoin(){
    const H=canvas.height/window.devicePixelRatio, groundY=H-GROUND_H, size=26*MOBILE_SCALE;
    if(Math.random()<0.36){
      const baseX = canvas.width/window.devicePixelRatio + 40, apexY = groundY - (110 + Math.random()*80), span = 120 + Math.random()*90;
      const n = 5 + (Math.random()*3|0);
      for(let i=0;i<n;i++){
        const u=i/(n-1), y= groundY - ( (1-(2*u-1)**2) * (groundY - apexY) );
        coins.push({x:baseX + u*span, y, r:size/2, name:courseNames[(Math.random()*courseNames.length)|0], collected:false, arc:true});
      }
    }else{
      const y=groundY - (80 + Math.random()*100);
      coins.push({x:canvas.width/window.devicePixelRatio + 40, y, r:size/2, name:courseNames[(Math.random()*courseNames.length)|0], collected:false});
    }
  }
  function spawnHeart(){ const H=canvas.height/window.devicePixelRatio, groundY=H-GROUND_H, r=16*MOBILE_SCALE; hearts.push({x:canvas.width/window.devicePixelRatio + 42, y:groundY-(90+Math.random()*100), r, collected:false}); }
  function spawnStar(){ const H=canvas.height/window.devicePixelRatio, groundY=H-GROUND_H, r=16*MOBILE_SCALE; stars.push({x:canvas.width/window.devicePixelRatio + 52, y:groundY-(110+Math.random()*90), r, t:0, collected:false}); }

  // Input
  function doJump(){ if(!running || paused || over) return; if(player.jumpsLeft>0){ player.vy=-10.4; player.onGround=false; player.jumpsLeft--; } }
  window.addEventListener('keydown', e=>{ if(e.code==='Space'||e.code==='ArrowUp'){e.preventDefault(); doJump();} if(e.code==='KeyP'){ paused=!paused; updatePauseUI(); } }, {passive:false});
  pauseBtn.addEventListener('click', ()=>{ paused=!paused; updatePauseUI(); });
  $('#pauseFloatBtn').addEventListener('click', ()=>{ paused=!paused; updatePauseUI(); });
  function updatePauseUI(){ pauseBtn.textContent = paused ? '▶️' : '⏸️'; }

  let mute=true;
  muteBtn.addEventListener('click', ()=>{ mute=!mute; muteBtn.textContent = mute ? '🔇' : '🔊'; });

  // Helpers
  function rectsOverlap(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }
  function circleRectOverlap(c, r){ const cx=Math.max(r.x, Math.min(c.x, r.x+r.w)); const cy=Math.max(r.y, Math.min(c.y, r.y+r.h)); const dx=c.x-cx, dy=c.y-cy; return dx*dx+dy*dy<=c.r*c.r; }

  // Draw
  function draw(){
    const W=canvas.width/window.devicePixelRatio, H=canvas.height/window.devicePixelRatio, groundY=H-GROUND_H;
    ctx.clearRect(0,0,W,H);
    ctx.globalAlpha=.08; ctx.fillStyle='#2a7cf7'; for(let i=0;i<6;i++){ const y=40+i*44+(time*speed*0.4+i*30)%44; ctx.fillRect(0,y,W,2);} ctx.globalAlpha=1;
    ctx.fillStyle='#e3e7ef'; ctx.fillRect(0,groundY,W,GROUND_H);
    ctx.fillStyle='#cfd6e3'; for(let x=0;x<W;x+=24){ ctx.fillRect((x-(time*speed)%24), groundY+22, 12,2); }
    for(const c of coins){ ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fillStyle='#ffcf33'; ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle='#e0a800'; ctx.stroke(); }
    for(const h of hearts){ ctx.save(); ctx.font = `bold ${h.r*2+6}px "Apple Color Emoji","Noto Color Emoji",system-ui`; ctx.textBaseline='middle'; ctx.textAlign='center'; ctx.fillText('❤️',h.x,h.y); ctx.restore(); }
    for(const s of stars){ ctx.save(); ctx.font = `bold ${s.r*2+8}px "Apple Color Emoji","Noto Color Emoji",system-ui`; ctx.textBaseline='middle'; ctx.textAlign='center'; ctx.fillText('🪨',s.x,s.y); ctx.restore(); }
    for(const o of obstacles){ ctx.fillStyle='#23242a'; ctx.fillRect(o.x,o.y,o.w,o.h); }
    // player
    const fontPx = Math.max(player.h+6, 36);
    ctx.save();
    if(player.facing === 1){ ctx.translate(player.x + player.w, 0); ctx.scale(-1,1); ctx.font = `bold ${fontPx}px "Apple Color Emoji","Noto Color Emoji",system-ui`; ctx.textBaseline='top'; ctx.fillText(selectedChar, 0, player.y - (fontPx - player.h)/2);
    }else{ ctx.font = `bold ${fontPx}px "Apple Color Emoji","Noto Color Emoji",system-ui`; ctx.textBaseline='top'; ctx.fillText(selectedChar, player.x, player.y - (fontPx - player.h)/2); }
    ctx.restore();
  }

  function showToast(msg){ const el=$('#toast'); el.textContent=msg; el.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>el.classList.remove('show'),1200); }
  function showCombo(){ const el=$('#comboPop'); el.textContent=`COMBO x${combo}!`; el.classList.add('show'); clearTimeout(showCombo._t); showCombo._t=setTimeout(()=>el.classList.remove('show'),800); }

  // Flow
  let time=0, speed=4.2, baseSpeed=4.2;
  function resizePlayerOnly(){ const H=canvas.height/window.devicePixelRatio; player.w=Math.round(46*MOBILE_SCALE); player.h=Math.round(52*MOBILE_SCALE); player.y=H-GROUND_H-player.h; }
  function reset(full=true){
    running=false; paused=false; over=false; score=0; combo=1; time=0; speed=baseSpeed;
    lives=3; invulHit=0; invulPower=0; updateHUD();
    const H=canvas.height/window.devicePixelRatio; player.y=H-GROUND_H-player.h; player.vy=0; player.onGround=true; player.jumpsLeft=2; player.facing=1;
    if(full){ obstacles.length=0; coins.length=0; hearts.length=0; stars.length=0; obsTimer=0; coinTimer=0; heartTimer=8+Math.random()*10; starTimer=10+Math.random()*10; }
  }
  function start(){ startOverlay.style.display='none'; reset(true); running=true; updatePauseUI(); }
  function restart(){ gameOverOverlay.style.display='none'; reset(true); running=true; updatePauseUI(); }
  $('#startBtn').addEventListener('click', start);
  $('#retryBtn').addEventListener('click', restart);
  $('#changeCharBtn').addEventListener('click', ()=>{ gameOverOverlay.style.display='none'; reset(false); buildCharGrid(); startOverlay.style.display=''; });
  $('#changeDiffBtn').addEventListener('click', ()=>{ gameOverOverlay.style.display='none'; reset(false); initDiffButtons(); startOverlay.style.display=''; });
  $('#homeLogo').addEventListener('click', ()=>{ startOverlay.style.display=''; reset(false); });

  // Start screen init
  function toStart(){ startOverlay.style.display=''; buildCharGrid(); initDiffButtons(); $('#diffLabel').textContent=(DIFF_PRESETS[selectedDiff]||DIFF_PRESETS.normal).label; fitCanvas(); }
  toStart();

  // Game over
  function gameOver(){
    over=true; running=false; paused=false;
    const final=Math.floor(score);
    const prevBest=Number(localStorage.getItem('mc_runner_best')||0);
    if(final>prevBest){ localStorage.setItem('mc_runner_best', String(final)); bestEl.textContent=final; } else { bestEl.textContent=prevBest; }
    $('#finalText').innerHTML=`이번 점수 <b>${final}</b>`;
    gameOverOverlay.style.display='';
  }

  // Step
  function step(dt){
    const H=canvas.height/window.devicePixelRatio, groundY=H-GROUND_H;
    if(invulHit>0) invulHit=Math.max(0,invulHit-dt); if(invulPower>0) invulPower=Math.max(0,invulPower-dt);
    player.vy+=24*dt; player.y+=player.vy; if(player.y+player.h>=groundY){ player.y=groundY-player.h; player.vy=0; if(!player.onGround){ player.onGround=true; player.jumpsLeft=2; } }
    const df = diffFactor(time);
    obsTimer-=dt; coinTimer-=dt; heartTimer-=dt; starTimer-=dt;
    if(obsTimer<=0){
      spawnObstacle();
      const burst = Math.random()<getPreset().burst ? Math.max(0.28,(0.5+Math.random()*0.6)/Math.pow(df,0.35)) : ((0.9+Math.random()*1.0)/Math.pow(df,0.35));
      obsTimer=Math.max(0.28, Math.min(burst, 3.2));
    }
    if(coinTimer<=0){ spawnCoin(); coinTimer=(1.2 + Math.random()*0.9)*getPreset().coinMul/Math.pow(df,0.25); }
    if(heartTimer<=0){ spawnHeart(); heartTimer=8+Math.random()*10; }
    if(starTimer<=0){ spawnStar(); starTimer=10+Math.random()*10; }

    for(let i=obstacles.length-1;i>=0;i--){
      const o=obstacles[i]; if(o.type==='float'){ o.t=(o.t||0)+dt*o.s; o.y+=Math.sin(o.t)*0.7; } o.x-=speed;
      if(rectsOverlap(player,o)){ if(invulPower>0){ } else if(invulHit<=0){ lives=Math.max(0, lives-1); invulHit=1.0; if(lives<=0){ gameOver(); break; } } }
      if(!o.passed && o.x + o.w < player.x){ o.passed=true; score+=3; }
      if(o.x+o.w<-10) obstacles.splice(i,1);
    }
    for(let i=coins.length-1;i>=0;i--){
      const c=coins[i]; c.x-=speed; if(circleRectOverlap(c, player)){ coins.splice(i,1); const now=performance.now(); combo=(now-lastCoinTime<2500)?(combo+1):1; lastCoinTime=now; score+=10*combo; showCombo(); }
      else if(c.x+c.r<-10) coins.splice(i,1);
    }
    for(let i=hearts.length-1;i>=0;i--){
      const h=hearts[i]; h.x-=speed*0.95; if(circleRectOverlap(h, player)){ hearts.splice(i,1); if(lives<maxLives){ lives++; } else { score+=5; } }
      else if(h.x+h.r<-10) hearts.splice(i,1);
    }
    for(let i=stars.length-1;i>=0;i--){
      const s=stars[i]; s.t=(s.t||0)+dt; s.x-=speed*1.03; s.y+=Math.sin(s.t*3.8)*0.55; if(circleRectOverlap(s, player)){ stars.splice(i,1); invulPower = invulPower>0 ? Math.min(invulPower+3,10) : 6; }
      else if(s.x+s.r<-10) stars.splice(i,1);
    }
    let nearest=null, nd=1e9; for(const o of obstacles){ const d=Math.abs((o.x+o.w/2)-(player.x+player.w/2)); if(d<nd){ nd=d; nearest=o; } }
    player.facing = nearest ? (((nearest.x + nearest.w/2) >= (player.x + player.w/2)) ? 1 : -1) : 1;
    const p=getPreset(); time+=dt; speed=Math.min(4.2 + time*p.speedSlope*df, p.speedMax); score+=dt*(1.2 + (df-1)*0.35); updateHUD();
  }

  // Loop
  let last=performance.now();
  function loop(now){
    requestAnimationFrame(loop);
    const dt=Math.max(0, Math.min((now-last)/1000, 0.033)); last=now;
    if(!running||paused||over){ draw(); return; }
    step(dt); draw();
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
